@inherits BladixComponentBase

@if (AsChild)
{
    <CascadingValue Value="this" IsFixed="true">
        @ChildContent
    </CascadingValue>
}
else
{
    <div @attributes="AdditionalAttributes"
         data-orientation="@Orientation.ToString().ToLowerInvariant()"
         data-bladix-accordion="true"
         class="@Class"
         style="@Style"
         @ref="ElementRef">
        <CascadingValue Value="this" IsFixed="true">
            @ChildContent
        </CascadingValue>
    </div>
}

@code {
    private HashSet<string> _openItems = new();
    private readonly List<AccordionTrigger> _triggers = new();

    [Parameter] public AccordionType Type { get; set; } = AccordionType.Single;
    [Parameter] public bool Collapsible { get; set; } = false;
    [Parameter] public string? Value { get; set; }
    [Parameter] public EventCallback<string?> ValueChanged { get; set; }
    [Parameter] public EventCallback<string[]?> ValuesChanged { get; set; }
    [Parameter] public string[]? DefaultValue { get; set; }
    [Parameter] public Orientation Orientation { get; set; } = Orientation.Vertical;
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public Direction Dir { get; set; } = Direction.Ltr;
    
    protected override void OnInitialized()
    {
        if (Type == AccordionType.Single)
        {
            if (!string.IsNullOrEmpty(Value))
            {
                _openItems.Add(Value);
            }
            else if (DefaultValue?.Length > 0)
            {
                _openItems.Add(DefaultValue[0]);
            }
        }
        else if (Type == AccordionType.Multiple && DefaultValue != null)
        {
            foreach (string item in DefaultValue)
            {
                _openItems.Add(item);
            }
        }
    }

    protected override void OnParametersSet()
    {
        if (Type == AccordionType.Single && !string.IsNullOrEmpty(Value))
        {
            if (_openItems.Count != 1 || !_openItems.Contains(Value))
            {
                _openItems.Clear();
                _openItems.Add(Value);
            }
        }
        else if (Type == AccordionType.Single && string.IsNullOrEmpty(Value) && Collapsible)
        {
            _openItems.Clear();
        }
        else if (Type == AccordionType.Multiple)
        {
            if (Value != null)
            {
                var parts = (Value.Length == 0)
                    ? Array.Empty<string>()
                    : Value.Split(new[] { ',' }, StringSplitOptions.RemoveEmptyEntries);

                var newSet = new HashSet<string>(StringComparer.Ordinal);
                foreach (var p in parts)
                {
                    var s = p.Trim();
                    if (!string.IsNullOrEmpty(s))
                        newSet.Add(s);
                }

                if (!_openItems.SetEquals(newSet))
                {
                    _openItems = newSet;
                }
            }
            else if (DefaultValue != null)
            {
                var expectedSet = new HashSet<string>(DefaultValue);
                if (!_openItems.SetEquals(expectedSet))
                {
                    _openItems = expectedSet;
                }
            }
        }
    }

    public bool IsItemOpen(string itemValue) => _openItems.Contains(itemValue);

    public async Task ToggleItem(string itemValue)
    {
        if (Disabled) return;

        if (Type == AccordionType.Single)
        {
            if (_openItems.Contains(itemValue))
            {
                if (Collapsible)
                {
                    _openItems.Clear();
                    await ValueChanged.InvokeAsync(null);
                }
            }
            else
            {
                _openItems.Clear();
                _openItems.Add(itemValue);
                await ValueChanged.InvokeAsync(itemValue);
            }
        }
        else 
        {
            if (_openItems.Contains(itemValue))
            {
                _openItems.Remove(itemValue);
            }
            else
            {
                _openItems.Add(itemValue);
            }

            var openItemsArray = _openItems.ToArray();
            await ValueChanged.InvokeAsync(string.Join(",", openItemsArray));
            await ValuesChanged.InvokeAsync(openItemsArray);
        }

        StateHasChanged();
    }

    public void RegisterTrigger(AccordionTrigger trigger)
    {
        if (!_triggers.Contains(trigger))
        {
            _triggers.Add(trigger);
        }
    }

    public void UnregisterTrigger(AccordionTrigger trigger)
    {
        _triggers.Remove(trigger);
    }

    public AccordionTrigger? GetNextTrigger(AccordionTrigger current)
    {
        int currentIndex = _triggers.IndexOf(current);
        if (currentIndex == -1) return null;

        for (int i = currentIndex + 1; i < _triggers.Count; i++)
        {
            if (!_triggers[i].IsDisabled)
                return _triggers[i];
        }

        for (int i = 0; i < currentIndex; i++)
        {
            if (!_triggers[i].IsDisabled)
                return _triggers[i];
        }

        return null;
    }

    public AccordionTrigger? GetPreviousTrigger(AccordionTrigger current)
    {
        int currentIndex = _triggers.IndexOf(current);
        if (currentIndex == -1) return null;

        for (int i = currentIndex - 1; i >= 0; i--)
        {
            if (!_triggers[i].IsDisabled)
                return _triggers[i];
        }

        for (int i = _triggers.Count - 1; i > currentIndex; i--)
        {
            if (!_triggers[i].IsDisabled)
                return _triggers[i];
        }

        return null;
    }

    public AccordionTrigger? GetFirstTrigger()
    {
        return _triggers.FirstOrDefault(t => !t.IsDisabled);
    }

    public AccordionTrigger? GetLastTrigger()
    {
        return _triggers.LastOrDefault(t => !t.IsDisabled);
    }
}
