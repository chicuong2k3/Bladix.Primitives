@inherits BladixComponentBase
@using System.Text.RegularExpressions

@if (AsChild)
{
    <CascadingValue Value="this" IsFixed="true">
        @if (ChildContentWithAttributes != null)
        {
            @ChildContentWithAttributes(AdditionalAttributes ?? new Dictionary<string, object>())
        }
        else
        {
            @ChildContent
        }
    </CascadingValue>
}
else
{
    <div @attributes="AdditionalAttributes"
         data-state="@(_isOpen ? "open" : "closed")"
         data-disabled="@(Disabled ? "true" : null)"
         data-orientation="@Root?.Orientation.ToString().ToLowerInvariant()"
         data-bladix-collection-item="true"
         class="@Class"
         style="@Style"
         @ref="ElementRef">
        <CascadingValue Value="this" IsFixed="true">
            @ChildContent
        </CascadingValue>
    </div>
}

@code {
    private bool _isOpen;
    private readonly string _fallbackHeaderId = $"bladix-accordion-header-{Guid.NewGuid():N}";
    private readonly string _fallbackContentId = $"bladix-accordion-content-{Guid.NewGuid():N}";
    private readonly string _fallbackTriggerId = $"bladix-accordion-trigger-{Guid.NewGuid():N}";
    private AccordionHeader? _header;
    private AccordionContent? _content;
    private AccordionTrigger? _trigger;

    [CascadingParameter] public AccordionRoot? Root { get; set; }

    [Parameter] public string Value { get; set; } = string.Empty;
    [Parameter] public bool Disabled { get; set; }

    public bool IsOpen => _isOpen;

    private static readonly Regex _idSanitizeRegex = new(@"[^A-Za-z0-9_\-:.]", RegexOptions.Compiled | RegexOptions.CultureInvariant);

    private static string SanitizeIdSuffix(string? value)
    {
        if (string.IsNullOrEmpty(value)) return string.Empty;

        var sanitized = _idSanitizeRegex.Replace(value!, "-");

        sanitized = sanitized.Trim('-');

        if (string.IsNullOrEmpty(sanitized))
        {
            return "value";
        }

        if (char.IsDigit(sanitized[0]))
            sanitized = "id-" + sanitized;

        return sanitized;
    }

    public string HeaderId => _fallbackHeaderId + (string.IsNullOrEmpty(Value) ? string.Empty : $"-{SanitizeIdSuffix(Value)}");
    public string ContentId => _fallbackContentId + (string.IsNullOrEmpty(Value) ? string.Empty : $"-{SanitizeIdSuffix(Value)}");
    public string TriggerId => _fallbackTriggerId + (string.IsNullOrEmpty(Value) ? string.Empty : $"-{SanitizeIdSuffix(Value)}");

    public bool HasHeader => _header != null;
    public bool HasContent => _content != null;
    public bool HasTrigger => _trigger != null;

    protected override void OnParametersSet()
    {
        if (Root != null)
        {
            _isOpen = Root.IsItemOpen(Value);
        }
    }

    public async Task Toggle()
    {
        if (Disabled || Root?.Disabled == true) return;
        if (Root != null) await Root.ToggleItem(Value);
    }

    internal void RegisterHeader(AccordionHeader header) => _header = header;
    internal void UnregisterHeader(AccordionHeader header) { if (_header == header) _header = null; }
    internal void RegisterContent(AccordionContent content) => _content = content;
    internal void UnregisterContent(AccordionContent content) { if (_content == content) _content = null; }
    internal void RegisterTrigger(AccordionTrigger trigger) => _trigger = trigger;
    internal void UnregisterTrigger(AccordionTrigger trigger) { if (_trigger == trigger) _trigger = null; }
}
